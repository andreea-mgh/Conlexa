<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>IPA Ruleset ⋄ Conlexa</title>
<link rel="stylesheet" href="/style.css"/>
</head>
<body>

<header>
  <h1><a href="/" class="entry-link">Conlexa</a></h1>
  <span class="subtitle" id="lang-label">IPA Ruleset</span>
</header>

<div class="layout">
  <aside>
    <button class="reset-btn" id="back-btn" onclick="window.location.href='/phono/ipa'">← Back</button>
  </aside>

  <main id="main" class="main-flex">
    <div class="loading">Loading</div>
  </main>
</div>

<script>
  const pathEnd = window.location.pathname.split('/').filter(Boolean).pop();
  const isIndex = pathEnd === 'ipa';
  const lang = isIndex ? null : pathEnd.toUpperCase();

  function esc(str) {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  async function loadIndex() {
    document.title = 'IPA Rulesets ⋄ Conlexa';
    document.getElementById('lang-label').textContent = 'IPA Rulesets';
    const main = document.getElementById('main');
    const res = await fetch('/api/langs');
    if (!res.ok) { main.innerHTML = '<div class="empty">Failed to load languages.</div>'; return; }
    const data = await res.json();
    if (data.langs.length === 0) {
      main.innerHTML = '<div class="empty">No languages found.</div>';
      return;
    }
    console.log(data.langs);
    main.innerHTML = '<h2>IPA Rulesets</h2>' + data.langs.map(l =>
      `<h3 class="page-link"><a href="/phono/ipa/${esc(l.code)}">${esc(l.name_en)} (${esc(l.code)})</a></h3>`
    ).join('');
    // back button to home page
    const backBtn = document.getElementById('back-btn');
    backBtn.onclick = () => { window.location.href = '/'; };
  }

  async function load() {
    const res = await fetch(`/api/langs/${lang}`);
    const main = document.getElementById('main');
    if (!res.ok) {
      main.innerHTML = '<div class="empty">Language not found.</div>';
      return;
    }
    const data = await res.json();
    document.title = `IPA Ruleset: ${data.code} ⋄ Conlexa`;
    document.getElementById('lang-label').textContent = `IPA Ruleset — ${data.code}`;
    main.innerHTML = `
      <textarea id="ruleset" class="edit-field" spellcheck="false" style="flex:1;min-height:400px">${esc(data.ipa_ruleset || '')}</textarea>
      <div class="form-actions">
        <button class="reset-btn reset-btn-accent" id="save-btn" onclick="save()">Save</button>
      </div>
    `;
  }

  async function save() {
    const btn = document.getElementById('save-btn');
    btn.textContent = 'Saving…';
    btn.disabled = true;
    const res = await fetch(`/api/langs/${lang}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ipa_ruleset: document.getElementById('ruleset').value }),
    });
    btn.disabled = false;
    if (res.ok) {
      btn.textContent = 'Saved';
      setTimeout(() => { btn.textContent = 'Save'; }, 1500);
    } else {
      btn.textContent = 'Save';
      alert('Save failed. Please try again.');
    }
  }

  isIndex ? loadIndex() : load();
</script>
</body>
</html>
