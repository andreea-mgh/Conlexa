<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Languages ⋄ Conlexa</title>
<link rel="stylesheet" href="/style.css"/>
</head>
<body>

<header>
  <h1><a href="/" class="entry-link">Conlexa</a></h1>
  <span class="subtitle" id="lang-label">Languages</span>
</header>

<div class="layout">
  <aside>
    <button class="reset-btn" id="back-btn" onclick="window.location.href='/'">← Back</button>
  </aside>

  <main id="main" class="main-flex">
    <div class="loading">Loading</div>
  </main>
</div>

<script>
  function esc(str) {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  function getQueryParam(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
  }

  async function loadLangDetail(code) {
    const main = document.getElementById('main');
    // subtitle
    const label = document.getElementById('lang-label');
    if (label) label.textContent = 'Language Details';
    
    const res = await fetch(`/api/langs/${encodeURIComponent(code)}`);
    if (!res.ok) {
      main.innerHTML = `<div class="empty">Language "${esc(code)}" not found.</div>`;
      return;
    }
    const lang = await res.json();
    renderLangDetail(lang);
  }

  function renderLangDetail(lang) {
    // console.log('Loaded lang:', lang);
    // set window title
    document.title = `${lang.name_en} (${lang.code}) ⋄ Conlexa`;
    const main = document.getElementById('main');
    main.innerHTML = `
      <div class="word-header">
        <div class="word-heading-row">
          <h2 class="word-heading">${esc(lang.name_en)}</h2>
          <span class="lang-badge">${esc(lang.code)}</span>
        </div>
        <h2>Grammar</h2>
        <div class="section-block">
          <div class="section-label">Parts of Speech</div>
          <ul class="list-block">
          ${lang.parts_of_speech.map(pos => `<li><span class="pos-badge">${esc(pos.code)}</span> <span class="pos-name">${esc(pos.name_en)}</span> <button class="delete-button" onclick="deletePartOfSpeech('${lang.code}', '${pos.code}')">delete</button></li>`).join('')}
          </ul>
          <div id="add-pos-section" class="inline-inputs" style="display:none; margin-top: 1rem;">
          <input type="text" id="new-pos-code" placeholder="CODE" class="edit-field" style="width:10em;flex-grow:unset" maxlength="10"/>
          <input type="text" id="new-pos-name" placeholder="NAME" class="edit-field"/>
          <button class="inline-submit-btn" onclick="addPartOfSpeech('${lang.code}')">Add</button>
          </div>
          <div style="color:var(--text-dim); font-size: 0.9em; margin-top: 0.5rem;"> <button class="info-button" onclick="showAddPartOfSpeech('${lang.code}')">+</button> Add part of speech</div>
        </div>
        ${lang.ipa_ruleset ? `<div class="section-block">
          <div class="section-label">IPA Ruleset <a href="/phono/ipa/${lang.code}" target="_blank">(Edit)</a></div>
          <pre class="edit-field">${esc(lang.ipa_ruleset)}</pre>
        </div>` : ''}
      </div>
    `;
  }

  function showAddPartOfSpeech(langCode) {
    document.getElementById('add-pos-section').style.display = 'flex';
  }

  async function addPartOfSpeech(langCode) {
    const codeInput = document.getElementById('new-pos-code');
    const nameInput = document.getElementById('new-pos-name');
    const code = codeInput.value.trim().toUpperCase();
    const name_en = nameInput.value.trim();
    if (!code || !name_en) {
      alert('Please fill in both code and name.');
      return;
    }
    const res = await fetch(`/api/langs/${encodeURIComponent(langCode)}/parts_of_speech`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code, name_en }),
    });
    if (!res.ok) {
      alert('Failed to add part of speech.');
      return;
    }
    // reload language details
    loadLangDetail(langCode);
  }

  async function deletePartOfSpeech(langCode, posCode) {
    if (!confirm(`Are you sure you want to delete part of speech "${posCode}"?`)) return;
    const res = await fetch(`/api/langs/${encodeURIComponent(langCode)}/parts_of_speech/${encodeURIComponent(posCode)}`, {
      method: 'DELETE',
    });
    if (!res.ok) {
      const detail = (await res.json()).detail || `Status code: ${res.status}`;
      alert(`Failed to delete part of speech. ${detail}`);
      return;
    }
    // reload language details
    loadLangDetail(langCode);
  }

  async function loadLangs() {
    const main = document.getElementById('main');
    const label = document.getElementById('lang-label');
    if (label) label.textContent = 'Languages';
    
    const res = await fetch('/api/langs');
    if (!res.ok) { main.innerHTML = '<div class="empty">Failed to load languages.</div>'; return; }
    const data = await res.json();

    if (!data.langs || data.langs.length === 0) {
      main.innerHTML = '<div class="empty">No languages found.</div>';
      return;
    }

    main.innerHTML = data.langs.map(l =>
      `<h3 class="page-link" onclick="window.location.href='?code=${encodeURIComponent(l.code)}'" style="cursor: pointer;">
        <span class="lang-badge">${esc(l.code)}</span> ${esc(l.name_en)}
      </h3>`
    ).join('');
  }

  const code = getQueryParam('code');
  if (code) {
    loadLangDetail(code);
  } else {
    loadLangs();
  }
</script>
</body>
</html>
